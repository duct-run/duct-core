# vim: set ft=sh syn=bash :
# shellcheck shell=bash

#
# Copyright (C) 2022 Chris 'sh0shin' Frage
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License, version 3,
# as published by the Free Software Foundation.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program. If not, see <https://www.gnu.org/licenses/>.
#

# duct-conf
# Load duct environment configuration.

# Enable/disbale processing config.
declare -g DUCT_CONF_ENABLE="${DUCT_CONF_ENABLE:-true}"

# Enable/disbale config debug messages.
declare -g DUCT_CONF_QUIET="${DUCT_CONF_QUIET:-false}"

# Configuration file search list (internal).
declare -g -a -r _DUCT_CONF_FILES=(
  "${HOME}/.config/duct/env"
  "${HOME}/.ductenv"
)

# config

# deps: duct-msg
# intl: true
# life: core
# desc: Read and process duct environment configuration.
# opts:
__duct_conf() {
  local CONF_FILE
  local -a CONF_ENV

  # shellcheck disable=SC1091
  # load mandatory message plugin
  source "${DUCT_PLUG_DIR}/core/duct-msg"

  if [[ "$DUCT_CONF_ENABLE" != true ]]
  then
    return
  fi

  local ENV
  local VAR
  local VAL
  local _VAL

  for CONF_FILE in "${_DUCT_CONF_FILES[@]}"
  do
    if [[ -s "$CONF_FILE" ]]
    then

      if [[ "$DUCT_CONF_QUIET" != true ]]
      then
        __duct_msg d "$CONF_FILE"
      fi

      # shellcheck disable=SC1090
      readarray -t CONF_ENV < <( ( set -x; source "$CONF_FILE"; set +x ) 2>&1 )

      for ENV in "${CONF_ENV[@]}"
      do
        if [[ "$ENV" =~ ([A-Z_]+)=([[:alnum:][:punct:][:blank:]]+) ]]
        then
          VAR="${BASH_REMATCH[1]:?}"
          VAL="${BASH_REMATCH[2]:?}"
          VAL="${VAL//"'"}"
          _VAL="$VAL"

          if [[ "$VAR" =~ (TOKEN|SECRET|PASS) ]]
          then
            _VAL="[HIDDEN]"
          fi

          if [[ "$DUCT_CONF_QUIET" != true ]]
          then
            __duct_msg d "${VAR}=${_VAL}"
          fi

          export "${VAR}=${VAL}"
        fi
      done
    fi
  done
}
readonly -f __duct_conf
